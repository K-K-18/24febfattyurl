{% extends "base.html" %}
{% load core_tags %}

{% block title %}Analytics - {{ link.get_display_code }} - FattyURL{% endblock %}

{% block content %}
<div class="relative min-h-screen">
    <!-- Background ambient glow -->
    <div class="absolute inset-0 pointer-events-none overflow-hidden">
        <div class="absolute top-[-10%] right-[-10%] w-[400px] h-[400px] bg-lime-500/5 rounded-full blur-[120px] animate-drift"></div>
        <div class="absolute bottom-[20%] left-[-5%] w-[300px] h-[300px] bg-emerald-500/4 rounded-full blur-[100px] animate-drift-reverse"></div>
    </div>

    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-12 gap-6 animate-fade-in-up">
            <div>
                <a href="{% url 'dashboard' %}" class="inline-flex items-center text-zinc-500 hover:text-lime-400 text-sm font-medium mb-4 transition-colors duration-200 group">
                    <i class="fa-solid fa-arrow-left mr-2 group-hover:-translate-x-1 transition-transform duration-200"></i>Back to Dashboard
                </a>
                <h1 class="text-4xl sm:text-5xl font-extrabold text-white font-display tracking-tight mb-3">
                    Link <span class="text-transparent bg-clip-text bg-gradient-to-r from-lime-300 to-emerald-400">Analytics</span>
                </h1>
                <div class="flex items-center gap-3">
                    <span class="px-3 py-1 rounded-lg bg-zinc-800/50 border border-zinc-700/50 text-lime-400 font-bold font-display text-sm">{{ link.get_display_code }}</span>
                    <p class="text-zinc-500 font-body text-sm truncate max-w-md" title="{{ link.original_url }}">{{ link.original_url }}</p>
                </div>
            </div>
            <div class="flex flex-wrap gap-3">
                <button onclick="copyToClipboard('{{ link.get_short_url }}', this)"
                        class="inline-flex items-center px-5 py-2.5 rounded-xl bg-zinc-900/50 border border-zinc-800 text-zinc-300 text-sm font-medium hover:bg-zinc-800 hover:text-white transition-all duration-200 backdrop-blur-sm">
                    <i class="fa-solid fa-copy mr-2 text-zinc-500"></i>Copy Link
                </button>
                <a href="{% url 'generate_qr' %}?url={{ link.get_short_url }}&format=png"
                   class="inline-flex items-center px-6 py-2.5 rounded-xl bg-lime-400 text-zinc-900 text-sm font-bold hover:bg-lime-300 transition-all duration-200 shadow-lg shadow-lime-500/20 hover:scale-[1.02] active:scale-[0.98]">
                    <i class="fa-solid fa-qrcode mr-2"></i>Download QR
                </a>
            </div>
        </div>

        <!-- Overview Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12 animate-fade-in-up delay-100">
            <div class="relative group">
                <div class="absolute -inset-px bg-gradient-to-r from-zinc-800 to-zinc-800 rounded-2xl group-hover:from-lime-500/20 group-hover:to-emerald-500/20 transition-all duration-500"></div>
                <div class="relative bg-zinc-900/40 backdrop-blur-xl border border-zinc-800/50 rounded-2xl p-6">
                    <p class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-1 font-display">Total Clicks</p>
                    <p class="text-3xl font-bold text-white font-display">{{ total_clicks }}</p>
                </div>
            </div>
            <div class="relative group">
                <div class="absolute -inset-px bg-gradient-to-r from-zinc-800 to-zinc-800 rounded-2xl group-hover:from-lime-500/20 group-hover:to-emerald-500/20 transition-all duration-500"></div>
                <div class="relative bg-zinc-900/40 backdrop-blur-xl border border-zinc-800/50 rounded-2xl p-6">
                    <p class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-1 font-display">Unique Visitors</p>
                    <p class="text-3xl font-bold text-emerald-400 font-display">{{ unique_visitors }}</p>
                </div>
            </div>
            <div class="relative group">
                <div class="absolute -inset-px bg-gradient-to-r from-zinc-800 to-zinc-800 rounded-2xl group-hover:from-lime-500/20 group-hover:to-emerald-500/20 transition-all duration-500"></div>
                <div class="relative bg-zinc-900/40 backdrop-blur-xl border border-zinc-800/50 rounded-2xl p-6">
                    <p class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-1 font-display">Created</p>
                    <p class="text-xl font-bold text-white font-display">{{ link.created_at|date:"M d, Y" }}</p>
                </div>
            </div>
            <div class="relative group">
                <div class="absolute -inset-px bg-gradient-to-r from-zinc-800 to-zinc-800 rounded-2xl group-hover:from-lime-500/20 group-hover:to-emerald-500/20 transition-all duration-500"></div>
                <div class="relative bg-zinc-900/40 backdrop-blur-xl border border-zinc-800/50 rounded-2xl p-6">
                    <p class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-1 font-display">Lifetime Clicks</p>
                    <p class="text-3xl font-bold text-white font-display">{{ link.click_count }}</p>
                </div>
            </div>
        </div>

        <!-- Date Range Filter -->
        <div class="flex flex-wrap gap-2 mb-8 animate-fade-in-up delay-200">
            <a href="?days=7" class="px-5 py-2 rounded-xl text-sm font-bold transition-all duration-200 font-display {% if days == 7 %}bg-lime-400 text-zinc-900 shadow-lg shadow-lime-500/20{% else %}bg-zinc-900/50 text-zinc-400 border border-zinc-800 hover:border-zinc-700 hover:text-white{% endif %}">7 Days</a>
            <a href="?days=30" class="px-5 py-2 rounded-xl text-sm font-bold transition-all duration-200 font-display {% if days == 30 %}bg-lime-400 text-zinc-900 shadow-lg shadow-lime-500/20{% else %}bg-zinc-900/50 text-zinc-400 border border-zinc-800 hover:border-zinc-700 hover:text-white{% endif %}">30 Days</a>
            <a href="?days=90" class="px-5 py-2 rounded-xl text-sm font-bold transition-all duration-200 font-display {% if days == 90 %}bg-lime-400 text-zinc-900 shadow-lg shadow-lime-500/20{% else %}bg-zinc-900/50 text-zinc-400 border border-zinc-800 hover:border-zinc-700 hover:text-white{% endif %}">90 Days</a>
            <a href="?days=365" class="px-5 py-2 rounded-xl text-sm font-bold transition-all duration-200 font-display {% if days == 365 %}bg-lime-400 text-zinc-900 shadow-lg shadow-lime-500/20{% else %}bg-zinc-900/50 text-zinc-400 border border-zinc-800 hover:border-zinc-700 hover:text-white{% endif %}">1 Year</a>
        </div>

        <!-- Clicks Chart -->
        <div class="relative bg-zinc-900/40 backdrop-blur-xl border border-zinc-800/50 rounded-2xl p-6 mb-12 animate-fade-in-up delay-300">
            <h2 class="text-xl font-bold text-white mb-6 font-display">Clicks Over Time</h2>
            <div class="h-[300px] w-full">
                <canvas id="clicksChart"></canvas>
            </div>
        </div>

        <!-- Data Tables Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12 animate-fade-in-up delay-400">
            <!-- Countries -->
            <div class="bg-zinc-900/40 backdrop-blur-xl border border-zinc-800/50 rounded-2xl p-6">
                <h3 class="text-lg font-bold text-white mb-6 font-display flex items-center">
                    <i class="fa-solid fa-globe mr-3 text-lime-400"></i>Top Countries
                </h3>
                {% if top_countries %}
                <div class="space-y-4">
                    {% for item in top_countries %}
                    <div class="flex items-center justify-between group">
                        <span class="text-zinc-400 font-body text-sm group-hover:text-zinc-200 transition-colors">{{ item.country }}</span>
                        <span class="text-zinc-200 font-bold font-display text-sm">{{ item.count }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-zinc-600 text-sm font-body italic">No data yet</p>
                {% endif %}
            </div>

            <!-- Cities -->
            <div class="bg-zinc-900/40 backdrop-blur-xl border border-zinc-800/50 rounded-2xl p-6">
                <h3 class="text-lg font-bold text-white mb-6 font-display flex items-center">
                    <i class="fa-solid fa-city mr-3 text-emerald-400"></i>Top Cities
                </h3>
                {% if top_cities %}
                <div class="space-y-4">
                    {% for item in top_cities %}
                    <div class="flex items-center justify-between group">
                        <span class="text-zinc-400 font-body text-sm group-hover:text-zinc-200 transition-colors">{{ item.city }}</span>
                        <span class="text-zinc-200 font-bold font-display text-sm">{{ item.count }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-zinc-600 text-sm font-body italic">No data yet</p>
                {% endif %}
            </div>

            <!-- Devices -->
            <div class="bg-zinc-900/40 backdrop-blur-xl border border-zinc-800/50 rounded-2xl p-6">
                <h3 class="text-lg font-bold text-white mb-6 font-display flex items-center">
                    <i class="fa-solid fa-laptop-mobile mr-3 text-lime-400"></i>Devices
                </h3>
                {% if device_breakdown %}
                <div class="space-y-4">
                    {% for item in device_breakdown %}
                    <div class="flex items-center justify-between group">
                        <div class="flex items-center text-zinc-400 font-body text-sm group-hover:text-zinc-200 transition-colors">
                            {% if item.device_type == 'mobile' %}<i class="fa-solid fa-mobile-screen mr-2 w-4"></i>
                            {% elif item.device_type == 'tablet' %}<i class="fa-solid fa-tablet-screen-button mr-2 w-4"></i>
                            {% elif item.device_type == 'desktop' %}<i class="fa-solid fa-desktop mr-2 w-4"></i>
                            {% else %}<i class="fa-solid fa-question mr-2 w-4"></i>{% endif %}
                            {{ item.device_type|title }}
                        </div>
                        <span class="text-zinc-200 font-bold font-display text-sm">{{ item.count }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-zinc-600 text-sm font-body italic">No data yet</p>
                {% endif %}
            </div>

            <!-- Browsers -->
            <div class="bg-zinc-900/40 backdrop-blur-xl border border-zinc-800/50 rounded-2xl p-6">
                <h3 class="text-lg font-bold text-white mb-6 font-display flex items-center">
                    <i class="fa-solid fa-window-maximize mr-3 text-emerald-400"></i>Browsers
                </h3>
                {% if browser_breakdown %}
                <div class="space-y-4">
                    {% for item in browser_breakdown %}
                    <div class="flex items-center justify-between group">
                        <span class="text-zinc-400 font-body text-sm group-hover:text-zinc-200 transition-colors">{{ item.browser }}</span>
                        <span class="text-zinc-200 font-bold font-display text-sm">{{ item.count }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-zinc-600 text-sm font-body italic">No data yet</p>
                {% endif %}
            </div>

            <!-- OS -->
            <div class="bg-zinc-900/40 backdrop-blur-xl border border-zinc-800/50 rounded-2xl p-6">
                <h3 class="text-lg font-bold text-white mb-6 font-display flex items-center">
                    <i class="fa-solid fa-server mr-3 text-lime-400"></i>Operating Systems
                </h3>
                {% if os_breakdown %}
                <div class="space-y-4">
                    {% for item in os_breakdown %}
                    <div class="flex items-center justify-between group">
                        <span class="text-zinc-400 font-body text-sm group-hover:text-zinc-200 transition-colors">{{ item.os }}</span>
                        <span class="text-zinc-200 font-bold font-display text-sm">{{ item.count }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-zinc-600 text-sm font-body italic">No data yet</p>
                {% endif %}
            </div>

            <!-- Referrers -->
            <div class="bg-zinc-900/40 backdrop-blur-xl border border-zinc-800/50 rounded-2xl p-6">
                <h3 class="text-lg font-bold text-white mb-6 font-display flex items-center">
                    <i class="fa-solid fa-arrow-up-right-from-square mr-3 text-emerald-400"></i>Top Referrers
                </h3>
                {% if top_referrers %}
                <div class="space-y-4">
                    {% for item in top_referrers %}
                    <div class="flex items-center justify-between group">
                        <span class="text-zinc-400 font-body text-sm group-hover:text-zinc-200 transition-colors truncate max-w-[180px]">{{ item.referrer|truncate_url:40 }}</span>
                        <span class="text-zinc-200 font-bold font-display text-sm">{{ item.count }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-zinc-600 text-sm font-body italic">No data yet</p>
                {% endif %}
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in-up delay-500">
            <!-- Edit Link Form -->
            <div class="lg:col-span-2 bg-zinc-900/40 backdrop-blur-xl border border-zinc-800/50 rounded-2xl p-8">
                <h3 class="text-2xl font-bold text-white mb-6 font-display flex items-center">
                    <i class="fa-solid fa-pen mr-3 text-lime-400"></i>Edit Link
                </h3>
                <form method="post" action="{% url 'edit_link' link.pk %}" class="space-y-6">
                    {% csrf_token %}
                    <div>
                        <label class="block text-sm font-bold text-zinc-400 uppercase tracking-widest mb-2 font-display">Destination URL</label>
                        {{ edit_form.original_url }}
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-zinc-400 uppercase tracking-widest mb-2 font-display">Title (optional)</label>
                        {{ edit_form.title }}
                    </div>
                    <button type="submit" class="inline-flex items-center px-8 py-3.5 rounded-xl bg-lime-400 text-zinc-900 font-bold hover:bg-lime-300 transition-all duration-200 shadow-lg shadow-lime-500/20 hover:scale-[1.02] active:scale-[0.98] cursor-pointer">
                        <i class="fa-solid fa-save mr-2"></i>Save Changes
                    </button>
                </form>
            </div>

            <!-- Delete Link -->
            <div class="bg-rose-500/5 backdrop-blur-xl border border-rose-500/20 rounded-2xl p-8">
                <h3 class="text-xl font-bold text-rose-400 mb-4 font-display">Danger Zone</h3>
                <p class="text-zinc-400 text-sm font-body mb-8 leading-relaxed">Deactivating this link will make it stop redirecting. All analytics data will be preserved.</p>
                <form method="post" action="{% url 'delete_link' link.pk %}" onsubmit="return confirm('Are you sure you want to deactivate this link?');">
                    {% csrf_token %}
                    <button type="submit" class="w-full inline-flex items-center justify-center px-6 py-3.5 rounded-xl border border-rose-500/30 text-rose-400 font-bold hover:bg-rose-500 hover:text-white transition-all duration-200">
                        <i class="fa-solid fa-trash mr-2"></i>Deactivate Link
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const ctx = document.getElementById('clicksChart').getContext('2d');
    
    // Gradient for the chart
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(163, 230, 53, 0.2)');
    gradient.addColorStop(1, 'rgba(163, 230, 53, 0)');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [{
                label: 'Clicks',
                data: {{ chart_data|safe }},
                borderColor: '#a3e635',
                borderWidth: 3,
                backgroundColor: gradient,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#a3e635',
                pointBorderColor: '#09090b',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: '#bef264',
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#18181b',
                    titleFont: { family: 'Bricolage Grotesque', size: 14 },
                    bodyFont: { family: 'Outfit', size: 13 },
                    padding: 12,
                    cornerRadius: 8,
                    displayColors: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: { 
                        stepSize: 1,
                        color: '#71717a',
                        font: { family: 'Outfit' }
                    },
                },
                x: {
                    grid: { display: false },
                    ticks: { 
                        color: '#71717a',
                        font: { family: 'Outfit' }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
